<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>Hello, world!</title>
  </head>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <!-- D3 -->
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <style> 
      circle {opacity: 0.65;} 
      body {background:#eee; 
            margin:0; 
            font-family: "Helvetica Neue", Helvetica, sans-serif;
            font-size: 16px;
            color: #333;}
      /*text {font-family: "Helvetica Neue", Helvetica, sans-serif;
            font-size: 16px;
            color: #333;}*/
      #slider {
        display: block;
        z-index:1;
        position:absolute;
        top:0;
        left:5%;
      }      
      #whiteCanvas {
      display:block; border:1px solid #ccc; position:absolute;
      top:5%; left:5%; width:90%; height:90%; background:#fff;
      z-index:-1;
      }
      h1 {
        text-align: center;
      }
    .ticks {
      font-size: 10px;
    }

    .track,
    .track-inset,
    .track-overlay {
      stroke-linecap: round;
    }

    .track {
      stroke: #000;
      stroke-opacity: 0.3;
      stroke-width: 10px;
    }

    .track-inset {
      stroke: #dcdcdc;
      stroke-width: 8px;
    }

    .track-overlay {
      pointer-events: stroke;
      stroke-width: 50px;
      stroke: transparent;
      cursor: crosshair;
    }

    .handle {
      fill: #fff;
      stroke: #000;
      stroke-opacity: 0.5;

    </style>
    <!-- The narrative visualization should be built with scenes, annotations, parameters, and triggers. -->

    <!-- The scenes should follow a template for visual consistency and follow an order to best convey the message. One way to implement different scenes is to make each a separate web page. Another way is to use d3.select(id).html = "" to clear the contents of a container element (e.g. an SVG element) and then repopulate that element using .append().
    The annotations should follow a template for visual consistency from scene to scene. These annotations should also highlight and reinforce specific data items or trends that make the important points for the desired messaging of the narrative visualization. The lessons on d3 popups can be helpful on how to to make and place annotations, but as an annotation, they should appear as part of the scene and not have to wait for a mouseover event.
    The parameters are the state variables of your narrative visualization. Your narrative visualization should use these parameters to control the construction of scenes. These parameters will be key variables in your JavaScript code, as well as parameters to key functions used to set up each scene.
    The triggers connect user interface actions to changes in parameters that change the state of the narrative visualization. These triggers can be event listeners (callback functions) that change parameter values and then update the display to reflect the result of the event.-->   

<body onload='init()'>
<h1>Hello, world!</h1> 
<div id="slider"></div>
<svg id="whiteCanvas"></svg>
<script>
async function init() {
  const dataset = await d3.csv('https://mm026184.github.io/mjm31-cs-498-narrative-viz/files/internet_clean_data.csv');
  console.log(dataset);
  var whiteCanvas = document.getElementById('whiteCanvas');

  var translateOrigin = 100;

  console.log('client', whiteCanvas.clientWidth + 'x' + whiteCanvas.clientHeight);

  var xScale = d3.scaleLinear().domain([0,100]).range([0,whiteCanvas.clientWidth-(translateOrigin+50)]);
  var yScale = d3.scaleLinear().domain([0,6]).range([whiteCanvas.clientHeight-(translateOrigin+100),0]);
  var rScale = d3.scaleSqrt().domain([9000,1378665000]).range([2,50]); 

  var xScaleHorPos = whiteCanvas.clientHeight-translateOrigin;

  var dataPlot = d3.select('svg')
      .append('g')
      .attr('transform','translate(' + translateOrigin+ ',' + translateOrigin + ')');

  // Add a scale for bubble color
  var dataColor = d3.scaleOrdinal()
    .domain(['Low income','Lower middle income','Upper middle income','High income'])
    .range(['#8f5bc8','#fe4a46','#f19300','#4c6800']);

  var changeStrokeOnHover = function() {
    d3.select(this).style('stroke','black');
  }

  var changeBackStroke = function() {
    d3.select(this).style('stroke','');
  }

  var selectedInd = 0;

  var handleClick = function(d) {
    
    var curOp = d3.select(this).style('opacity');
    console.log(selectedInd);
    var curYear = d.Year;
    var curCountry = d.CountryName;

    if (selectedInd == 0) {
      //d3.selectAll('circle').style('opacity',0.05);
      selectedInd = 1;
      filterDataset(curCountry,2100);
      //d3.selectAll('circle').data(d)
      //.append('circle')
      //.attr('cx',function(d) {return xScale(+d.PercUsingInternet);})
      //.attr('cy',function(d) {return yScale(+d.InnovationsPerThousand);})
      //.attr('r',function(d) {return rScale(+d.Population);})
      //.attr('class','bubbleData')
      //.style('fill',function(d) {return dataColor(d.IncomeGroup);});      
    } else {
      //d3.selectAll("svg > *").remove();
      selectedInd = 0;  
      filterDataset('',curYear);
      updateSlider(curYear);
    }
  }

  //function buildAxis() {
  var fSize = '14px';

  var yAxis = d3.select('svg')
          .append('g')
          .attr('transform','translate(' + translateOrigin+ ',' + translateOrigin + ')')
          .call(d3.axisLeft(yScale));
  
  var xAxis = d3.select('svg')
          .append('g')
          .attr('transform','translate(' + translateOrigin+ ',' + xScaleHorPos + ')')
          .call(d3.axisBottom(xScale));

  xAxis.selectAll('text')
      .attr('font-size',fSize);
  yAxis.selectAll('text')
      .attr('font-size',fSize);

  //xAxisLabel
  d3.select('svg').append("text")
    .attr("x",(whiteCanvas.clientWidth-(translateOrigin+50))/2)
    .attr("y", xScaleHorPos+50)
    .attr('class','xAxisLabel')
    .text('% of population using internet');

  var yLabelHeight = -((whiteCanvas.clientHeight-(translateOrigin+50))/2)
  //yAxisLabel
  d3.select('svg')
    .append("text")
    .attr('text-anchor', 'middle')
    .attr("transform", "translate("+ (translateOrigin/2) +","+(whiteCanvas.clientHeight/2)+")rotate(-90)")      
    .attr('class','yAxisLabel')
    .text('Innovations per 1000 residents');    
  //}

  function filterDataset(country='',year=2100) {
    var newData = dataset
      .filter(function(d) {return d.Population > 0;});

    if (country > '') {
      newData = newData.filter(function(d) {return d.CountryName == country;})
      addBigText(country);
    }

    if (year != 2100) {
      newData = newData.filter(function(d) {return d.Year == year;});
      addBigText(year);
    }

    console.log(newData);
    buildChartFromData(newData);

  }

  function buildChartFromData(data){

    d3.selectAll("circle.bubbleData").remove();
    //buildAxis();

    var circles = dataPlot.selectAll('circle').data(data);

    var radius = function(d) { 
      if (selectedInd == 0) {
        return rScale(+d.Population); 
      } else {
        if (rScale(+d.Population) > 10) {
          return 10;
        } else {
          return rScale(+d.Population);
        }
      }
    }

    circles.enter()
      .append('circle')
      .attr('cx',function(d) {return xScale(+d.PercUsingInternet);})
      .attr('cy',function(d) {return yScale(+d.InnovationsPerThousand);})
      .attr('r',radius)
      .attr('class','bubbleData')
      //.attr('r',function(d) {if (rScale(+d.Population) > 10) { return 10;} else { return rScale(+d.Population);}})
      .style('fill',function(d) {return dataColor(d.IncomeGroup);})
      .on("mouseover",changeStrokeOnHover)
      .on("mouseout",changeBackStroke)
      .on("click",handleClick);
        
  }

  function addBigText(value) {

    d3.select("text.centerText").text(value);
  }

  var playData = function() {
    startYear = 1993
    endYear = 2016

    d3.selectAll("svg > *").remove();

    for (year = startYear; year < endYear; year++) {
      nextYear = year + 1;
      console.log(year);
      buildChartFromData(year,nextYear,'');
    }

  }


  filterDataset('',2016);
  d3.select('svg')
      .append('g')
      .attr('transform','translate(' + translateOrigin+ ',' + translateOrigin + ')')
      .append("text")
      .attr("x",(whiteCanvas.clientWidth-(translateOrigin+50))/2)
      .attr("y", whiteCanvas.clientHeight/2 - translateOrigin)
      .attr('font-size','48px')
      .attr('text-anchor','middle')
      .attr('fill','#C0C0C0')
      .attr('opacity',0.65)
      .attr('class','centerText')
      .text(2016);  

  ////////// slider //////////
  var margin = {top:0, right:whiteCanvas.clientWidth/4, bottom:0, left:whiteCanvas.clientWidth/4},
      width = whiteCanvas.clientWidth - margin.left - margin.right,
      height = 180  - margin.top - margin.bottom;

  var startDate = 1993,
      endDate = 2016;

  var svgSlider = d3.select("#slider")
    .append("svg")
    .attr("width", whiteCanvas.clientWidth)
    .attr("height", height);
    
  var x = d3.scaleLinear()
    .domain([startDate, endDate])
    .range([0, width])
    .clamp(true);

  var slider = svgSlider.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(" + margin.left + ",150)");

  slider.append("line")
      .attr("class", "track")
      .attr("x1", x.range()[0])
      .attr("x2", x.range()[1])
    .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
      .attr("class", "track-inset")
    .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
      .attr("class", "track-overlay")
      .call(d3.drag()
          .on("start.interrupt", function() { slider.interrupt(); })
          .on("start drag", function() { updateSlider(x.invert(d3.event.x)); }));

  slider.insert("g", ".track-overlay")
    .attr("class", "ticks")
    .attr("transform", "translate(0," + 18 + ")")
    .selectAll("text")
      .data(x.ticks(23))
      .enter()
      .append("text")
      .attr("x", x)
      .attr("y", 10)
      .attr("text-anchor", "middle")
      .text(function(d) {return d });

  var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 9);

  var label = slider.append("text")  
    .attr("class", "label")
    .attr("text-anchor", "middle")
    .text(startDate)
    .attr("transform", "translate(0," + (-15) + ")");

  function updateSlider(h) {
    selectedInd = 0;
    
    // update position and text of label according to slider scale
    handle.attr("cx", x(h));
  
    var l = Math.round(h);
  
    label
      .attr("x", x(h))
      .text(l);
  
    // filter data set and redraw plot
    filterDataset('',l);
  }

  updateSlider(2016);
}
</script>
</body>
</html>