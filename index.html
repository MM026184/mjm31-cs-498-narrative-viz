<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>Hello, world!</title>
  </head>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <!-- D3 -->
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <style> 
      circle {opacity: 0.65;} 
      body {background:#eee; 
            margin:0; 
            font-family: "Helvetica Neue", Helvetica, sans-serif;
            font-size: 16px;
            color: #333;}
      /*text {font-family: "Helvetica Neue", Helvetica, sans-serif;
            font-size: 16px;
            color: #333;}*/

      #svg1 {
      display:block; border:1px solid #ccc; position:absolute;
      top:5%; left:5%; width:90%; height:90%; background:#fff;
      }
      h1 {
        text-align: center;
      }
    #play-button {
      position: absolute;
      top: 140px;
      left: 50px;
      background: #f08080;
      padding-right: 26px;
      border-radius: 3px;
      border: none;
      color: white;
      margin: 0;
      padding: 0 12px;
      width: 60px;
      cursor: pointer;
      height: 30px;
    }

    #play-button:hover {
      background-color: #696969;
    }    
    
    .ticks {
      font-size: 10px;
    }

    .track,
    .track-inset,
    .track-overlay {
      stroke-linecap: round;
    }

    .track {
      stroke: #000;
      stroke-opacity: 0.3;
      stroke-width: 10px;
    }

    .track-inset {
      stroke: #dcdcdc;
      stroke-width: 8px;
    }

    .track-overlay {
      pointer-events: stroke;
      stroke-width: 50px;
      stroke: transparent;
      cursor: crosshair;
    }

    .handle {
      fill: #fff;
      stroke: #000;
      stroke-opacity: 0.5;
      stroke-width: 1.25px;
    }      

    </style>
    <!-- The narrative visualization should be built with scenes, annotations, parameters, and triggers. -->

    <!-- The scenes should follow a template for visual consistency and follow an order to best convey the message. One way to implement different scenes is to make each a separate web page. Another way is to use d3.select(id).html = "" to clear the contents of a container element (e.g. an SVG element) and then repopulate that element using .append().
    The annotations should follow a template for visual consistency from scene to scene. These annotations should also highlight and reinforce specific data items or trends that make the important points for the desired messaging of the narrative visualization. The lessons on d3 popups can be helpful on how to to make and place annotations, but as an annotation, they should appear as part of the scene and not have to wait for a mouseover event.
    The parameters are the state variables of your narrative visualization. Your narrative visualization should use these parameters to control the construction of scenes. These parameters will be key variables in your JavaScript code, as well as parameters to key functions used to set up each scene.
    The triggers connect user interface actions to changes in parameters that change the state of the narrative visualization. These triggers can be event listeners (callback functions) that change parameter values and then update the display to reflect the result of the event.-->   

<body onload='init()'>
<h1>Hello, world!</h1>  
<svg id="svg1"></svg>
<script>
async function init() {
  const dataset = await d3.csv('https://mm026184.github.io/mjm31-cs-498-narrative-viz/files/internet_clean_data.csv');
  console.log(data);
  var svg1 = document.getElementById('svg1');

  var translateOrigin = 100;

  console.log('client', svg1.clientWidth + 'x' + svg1.clientHeight);

  var xScale = d3.scaleLinear().domain([0,100]).range([0,svg1.clientWidth-(translateOrigin+50)]);
  var yScale = d3.scaleLinear().domain([0,6]).range([svg1.clientHeight-(translateOrigin+100),0]);
  var rScale = d3.scaleSqrt().domain([9000,1378665000]).range([2,50]); 

  var xScaleHorPos = svg1.clientHeight-translateOrigin;

  var svgPlot = d3.select('svg')
      .append('g')
      .attr('transform','translate(' + translateOrigin+ ',' + translateOrigin + ')');

  // Add a scale for bubble color
  var dataColor = d3.scaleOrdinal()
    .domain(['Low income','Lower middle income','Upper middle income','High income'])
    .range(['#8f5bc8','#fe4a46','#f19300','#4c6800']);

  var changeStrokeOnHover = function() {
    d3.select(this).style('stroke','black');
  }

  var changeBackStroke = function() {
    d3.select(this).style('stroke','');
  }

  var selectedInd = 0;

  var handleClick = function(d) {
    
    var curOp = d3.select(this).style('opacity');
    console.log(selectedInd);
    var curYear = d.Year;
    var curCountry = d.CountryName;

    if (selectedInd == 0) {
      d3.selectAll('circle').style('opacity',0.05);
      buildChartFromData(2100,2100,curCountry);
      d3.select(this).style('opacity',0.95);
      selectedInd = 1;
    } else {
      d3.selectAll("svg > *").remove();
      buildChartFromData(curYear,2100,'');
      selectedInd = 0;  
    }
  }

  function buildAxis() {
    var fSize = '14px';

    var yAxis = svgPlot
          .call(d3.axisLeft(yScale));
  
    var xAxis = svgPlot
          .call(d3.axisBottom(xScale));

    xAxis.selectAll('text')
      .attr('font-size',fSize);
    yAxis.selectAll('text')
      .attr('font-size',fSize);    
  }

  function filterDataset(country='',year=2100) {
    if (country > '') {
      var newData = dataset
        .filter(function(d) {return d.CountryName == country;})
        .filter(function(d) {return d.Population > 0;})
      buildChartFromData(newData);
    }

    if (year != 2100) {
      var newData = dataset
        .filter(function(d) {return d.Year == year;})
        .filter(function(d) {return d.Population > 0;})
      buildChartFromData(newData);      
    }
  }

  function buildChartFromData(data){

    d3.selectAll("text").remove();
    buildAxis();

    var circles = svgPlot.selectAll('circle').data(data);

    circles.enter()
      .append('circle')
      .attr('cx',function(d) {return xScale(+d.PercUsingInternet);})
      .attr('cy',function(d) {return yScale(+d.InnovationsPerThousand);})
      .attr('r',function(d) {if (rScale(+d.Population) > 10) { return 10;} else { return rScale(+d.Population);}})
      .style('fill',function(d) {return dataColor(d.IncomeGroup);})
      .on("mouseover",changeStrokeOnHover)
      .on("mouseout",changeBackStroke)
      .on("click",handleClick);

    circles.exit()
      .remove();
    if (country > '' && year == 2100 && next_year == 2100) {
      d3.select('svg')
        .append('g')
        .attr('transform','translate(' + translateOrigin+ ',' + translateOrigin + ')')
        .selectAll('circle')
        .data(data)
        .enter()
        .append('circle')
        .filter(function(d) {return d.CountryName == country;})
        .filter(function(d) {return d.Population > 0;})
        .attr('cx',function(d) {return xScale(+d.PercUsingInternet);})
        .attr('cy',function(d) {return yScale(+d.InnovationsPerThousand);})
        .attr('r',function(d) {if (rScale(+d.Population) > 10) { return 10;} else { return rScale(+d.Population);}})
        .style('fill',function(d) {return dataColor(d.IncomeGroup);})
        .on("mouseover",changeStrokeOnHover)
        .on("mouseout",changeBackStroke)
        .on("click",handleClick);
      d3.select('svg')
        .append('g')
        .attr('transform','translate(' + translateOrigin+ ',' + translateOrigin + ')')
        .append("text")
        .attr("x",(svg1.clientWidth-(translateOrigin+50))/2)
        .attr("y", 200)
        .attr('font-size','48px')
        .attr('text-anchor','middle')
        .attr('fill','#C0C0C0')
        .attr('opacity',0.65)
        .text(country);         
    }

    if (year != 2100 && next_year == 2100 && country == '') {
      d3.select('svg')
        .append('g')
        .attr('transform','translate(' + translateOrigin+ ',' + translateOrigin + ')')     
        .selectAll('circle')
        .data(data)
        .enter()
        .append('circle')
        .filter(function(d) {return d.Year == year;})
        .filter(function(d) {return d.Population > 0;})
        .attr('cx',function(d) {return xScale(+d.PercUsingInternet);})
        .attr('cy',function(d) {return yScale(+d.InnovationsPerThousand);})
        .attr('r',function(d) {return rScale(+d.Population);})
        .style('fill',function(d) {return dataColor(d.IncomeGroup);})
        .on("mouseover",changeStrokeOnHover)
        .on("mouseout",changeBackStroke)
        .on("click",handleClick);
      d3.select('svg')
        .append('g')
        .attr('transform','translate(' + translateOrigin+ ',' + translateOrigin + ')')
        .append("text")
        .attr("x",(svg1.clientWidth-(translateOrigin+50))/2)
        .attr("y", 200)
        .attr('font-size','48px')
        .attr('text-anchor','middle')
        .attr('fill','#C0C0C0')
        .attr('opacity',0.65)
        .text(year); 
    }

    if (year != 2100 && next_year != 2100 && country == '') {
      var trans = d3.transition()
        .duration(750)
        .ease(d3.easeLinear);

      var originalData = d3.select('svg')
        .append('g')
        .attr('transform','translate(' + translateOrigin+ ',' + translateOrigin + ')')     
        .selectAll('circle')
        .data(data)
        .enter()
        .append('circle')
        .filter(function(d) {return d.Year == year;})
        .filter(function(d) {return d.Population > 0;})
        .attr('cx',function(d) {return xScale(+d.PercUsingInternet);})
        .attr('cy',function(d) {return yScale(+d.InnovationsPerThousand);})
        .attr('r',function(d) {return rScale(+d.Population);})
        .style('fill',function(d) {return dataColor(d.IncomeGroup);});

      var newData = d3.selectAll('circle')
        .data(data)
        .filter(function(d) {return d.Year == next_year;})
        .filter(function(d) {return d.Population > 0;})

      //join new data with old
      var joinedData = originalData
        .join(newData);

      //exit old not in new
      joinedData.exit()
        .attr("class", "exit")
        .transition(trans)
        .remove();

      //enter new elements present in newdata
      joinedData.enter()
        .append('circle')
        .filter(function(d) {return d.Year == next_year;})
        .filter(function(d) {return d.Population > 0;})
        .attr('class','enter')
        .transition(trans)
        .attr('cx',function(d) {return xScale(+d.PercUsingInternet);})
        .attr('cy',function(d) {return yScale(+d.InnovationsPerThousand);})
        .attr('r',function(d) {return rScale(+d.Population);})
        .style('fill',function(d) {return dataColor(d.IncomeGroup);})        
        .on("mouseover",changeStrokeOnHover)
        .on("mouseout",changeBackStroke)
        .on("click",handleClick);

      /*var origText = d3.select('svg')
        .append('g')
        .attr('transform','translate(' + translateOrigin+ ',' + translateOrigin + ')')
        .append("text")
        .attr("x",(svg1.clientWidth-(translateOrigin+50))/2)
        .attr("y", 200)
        .attr('font-size','48px')
        .attr('text-anchor','middle')
        .attr('fill','#C0C0C0')
        .attr('opacity',0.65)
        .text(year);

      origText.transition(trans)
        .remove();
      
      d3.select('svg')
        .append('g')
        .attr('transform','translate(' + translateOrigin+ ',' + translateOrigin + ')')
        .append("text")
        .attr("x",(svg1.clientWidth-(translateOrigin+50))/2)
        .attr("y", 200)
        .attr('font-size','48px')
        .attr('text-anchor','middle')
        .attr('fill','#C0C0C0')
        .attr('opacity',0.65)
        .text(next_year);*/            
    }    
  }

  var playData = function() {
    startYear = 1993
    endYear = 2016

    d3.selectAll("svg > *").remove();

    for (year = startYear; year < endYear; year++) {
      nextYear = year + 1;
      console.log(year);
      buildChartFromData(year,nextYear,'');
    }

  }

  buildChartFromData(1993,2100,'');



}
</script>
</body>
</html>